# 模式10：自动录屏功能使用说明

## 功能概述

模式10为NIKKE竞技场助手添加了自动录屏功能，可以：
- 自动点击游戏界面中的5个播放按钮（Round 01-05）
- 自动开始录制对局回放视频
- 智能识别WIN结束界面（红色WIN/蓝色WIN）
- 检测到WIN界面后自动点击统计按钮
- 自动停止录屏并保存视频

## 使用前提

### 1. 启动界面要求
在运行模式10之前，您需要：
1. 启动NIKKE游戏
2. 进入竞技场
3. 打开"普级赛结果"弹窗（显示5场对局的界面）
4. **保持这个弹窗打开**，然后运行模式10

### 2. 系统要求
- Windows 10/11
- 管理员权限
- 足够的磁盘空间（每场约100-300MB）
- 游戏进程名为 `nikke.exe`

## 技术实现

### 核心功能
1. **窗口捕获**：只录制NIKKE游戏窗口，不录制整个屏幕
2. **自动点击**：使用相对坐标系统，自适应不同分辨率
3. **WIN界面识别**：通过颜色特征识别红色WIN（对方赢）和蓝色WIN（己方赢）
4. **统计按钮点击**：在停止录制前自动点击右下角统计按钮
5. **视频编码**：输出1080p 60fps MP4格式视频

### 关键参数配置

在 `config.json` 中的 `mode10` 配置项：

```json
"mode10": {
  "output_filename_suffix": "_recording",
  "num_matches": 5,           // 录制对局数量（1-5）
  "start_match": 0,           // 起始对局索引（0-4）
  "video_fps": 60,            // 视频帧率
  "video_resolution_width": 1920,   // 视频宽度
  "video_resolution_height": 1080   // 视频高度
}
```

## 使用方法

### 操作步骤
1. 启动 NIKKE 游戏
2. 进入竞技场，打开"普级赛结果"弹窗
3. 启动 NIKKE_CArena_Helper.exe
4. 选择"模式10：自动录屏"
5. 点击"运行"按钮
6. 程序将自动：
   - 依次点击每个播放按钮
   - 开始录制对局回放
   - 检测WIN结束界面
   - 点击统计按钮
   - 停止录制并保存视频

### 输出文件
- 视频文件保存在：`output_app/mode_10_recordings/`
- 文件命名格式：`match_1_20260215_143025.mp4`

## 坐标说明

### 播放按钮坐标（基于2048x1152分辨率测量）
```python
Round 01: (0.4297, 0.4062)
Round 02: (0.4297, 0.4358)
Round 03: (0.4297, 0.4661)
Round 04: (0.4297, 0.4957)
Round 05: (0.4297, 0.5252)
```

### 统计按钮坐标
```python
统计按钮: (0.4478, 0.6745)
```

这些坐标是相对坐标（0.0-1.0），应该适用于其他16:9分辨率。

## WIN界面识别

### 识别原理
程序通过检测屏幕上方30%区域的颜色特征来识别WIN界面：

#### 红色WIN（对方赢）
- 检测条件：R > 200, G < 80, B < 80
- 特征：大号红色"[WIN]"文字

#### 蓝色WIN（己方赢）
- 检测条件：R < 100, G > 180, B > 180
- 特征：大号青色"[WIN]"文字

### 检测流程
1. 录制开始后，每秒检测一次屏幕
2. 检测到WIN界面后：
   - 等待0.5秒（界面稳定）
   - 点击统计按钮
   - 等待0.5秒（数据显示）
   - 停止录制

## 调整参数

### 如果播放按钮位置不准确

编辑 `modes/mode10.py`，修改 `click_play_button` 函数中的坐标：

```python
play_button_coords_rel = [
    (0.4297, 0.4062),  # Round 01 - 调整这些值
    (0.4297, 0.4358),  # Round 02
    (0.4297, 0.4661),  # Round 03
    (0.4297, 0.4957),  # Round 04
    (0.4297, 0.5252),  # Round 05
]
```

**如何确定正确坐标**：
1. 截取游戏窗口完整截图
2. 使用图像编辑器测量窗口尺寸和按钮位置
3. 计算相对坐标：
   - X_rel = X_像素 / 窗口宽度
   - Y_rel = Y_像素 / 窗口高度

### 如果WIN界面检测不准确

编辑 `modes/mode10.py`，修改 `detect_win_screen` 函数中的参数：

```python
# 调整检测区域
detection_region_rel = (0.2, 0.05, 0.6, 0.3)

# 调整红色阈值
red_mask = (img_rgb[:,:,0] > 200) & \
           (img_rgb[:,:,1] < 80) & \
           (img_rgb[:,:,2] < 80)

# 调整青色阈值
cyan_mask = (img_rgb[:,:,0] < 100) & \
            (img_rgb[:,:,1] > 180) & \
            (img_rgb[:,:,2] > 180)

# 调整判断阈值
threshold = 0.005  # 可以调整为0.003-0.01之间
```

### 如果统计按钮位置不准确

编辑 `modes/mode10.py`，修改 `click_stats_button` 函数中的坐标：

```python
stats_button_coord_rel = (0.4478, 0.6745)  # 调整这个值
```

## 注意事项

1. **录制时长限制**：单场对局最长录制5分钟，超时自动停止
2. **窗口状态**：录制期间请勿最小化游戏窗口
3. **性能要求**：60fps录制需要较好的CPU性能
4. **存储空间**：每场对局视频约100-300MB
5. **初始界面**：必须在"普级赛结果"弹窗界面启动模式10

## 故障排除

### 问题1：点击位置不准确
**原因**：游戏分辨率或窗口大小与测量时不同
**解决方案**：
- 检查游戏分辨率设置
- 调整 `play_button_coords_rel` 中的坐标值
- 确保游戏窗口没有被缩放

### 问题2：无法检测WIN界面
**原因**：颜色阈值不匹配或检测区域不正确
**解决方案**：
- 调整 `detection_region_rel` 检测区域
- 修改红色/青色阈值参数
- 降低判断阈值（从0.005改为0.003）

### 问题3：录制的视频是黑屏
**原因**：窗口被遮挡或最小化
**解决方案**：
- 确保游戏窗口在前台
- 检查是否有其他窗口遮挡
- 尝试以管理员权限运行

### 问题4：统计按钮点击失败
**原因**：按钮位置不正确
**解决方案**：
- 调整 `stats_button_coord_rel` 坐标
- 检查WIN界面是否完全显示
- 增加等待时间

### 问题5：视频文件过大
**解决方案**：
- 降低 `video_fps` 参数（如改为30）
- 降低分辨率（如改为1280x720）
- 使用视频压缩工具后处理

## 性能优化

### 降低CPU占用
```json
"video_fps": 30,  // 从60降到30
```

### 降低文件大小
```json
"video_resolution_width": 1280,
"video_resolution_height": 720
```

### 只录制特定场次
```json
"num_matches": 1,     // 只录制1场
"start_match": 2      // 从第3场开始（0-4）
```

## 技术细节

### 录制流程
```
1. 激活游戏窗口
   ↓
2. 点击播放按钮 (Round 01-05)
   ↓
3. 等待2秒（视频加载）
   ↓
4. 开始录制（独立线程）
   ↓
5. 循环检测WIN界面（每秒一次）
   ├─ 检测到红色WIN → 继续
   ├─ 检测到蓝色WIN → 继续
   ├─ 未检测到 → 继续循环
   └─ 超时（5分钟）→ 跳到步骤7
   ↓
6. 检测到WIN界面后：
   - 等待0.5秒
   - 点击统计按钮
   - 等待0.5秒
   ↓
7. 停止录制
   ↓
8. 保存视频文件
   ↓
9. 退出到播放按钮界面：
   - 点击屏幕右侧（第1次）
   - 等待1秒
   - 点击屏幕右侧（第2次）
   - 等待0.5秒
   ↓
10. 等待1秒后录制下一场
```

### 多线程设计
- 录制在独立线程中运行，不阻塞主程序
- 主线程负责检测WIN界面和控制流程
- 线程安全的启动和停止机制

### 颜色检测算法
- 使用RGB色彩空间直接检测
- 检测屏幕上方30%区域
- 红色和青色阈值设置较严格，避免误判
- 像素占比阈值0.5%，平衡准确性和灵敏度

## 更新日志

### v1.1 (2026-02-15)
- 更新播放按钮坐标（基于实际截图测量）
- 改进WIN界面识别算法（支持红色和蓝色WIN）
- 添加统计按钮点击功能
- 优化检测流程和等待时间

### v1.0 (2026-02-15)
- 初始版本
- 支持5场对局自动录制
- 实现结果页面自动检测
- 输出1080p 60fps视频

## 技术支持

如需帮助，请提供：
1. 游戏分辨率设置
2. 错误日志（如果有）
3. 问题截图
4. 初始界面截图

---

**版本**: 1.1  
**更新日期**: 2026-02-15  
**作者**: Manus AI

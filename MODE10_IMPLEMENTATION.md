# NIKKE CArena Helper - 模式10自动录屏功能实现文档

## 项目概述

为现有的 NIKKE CArena Helper Windows 桌面应用添加了模式10自动录屏功能。该功能可以自动点击游戏界面中的播放按钮，录制对局回放视频，并在检测到对战结果页面后自动停止录屏。

## 实现内容

### 1. 新增文件

#### modes/mode10.py
核心录屏功能实现，包含：
- `VideoRecorder` 类：负责视频录制
  - 使用 OpenCV 进行视频编码
  - 多线程录制，不阻塞主程序
  - 支持自定义帧率和分辨率
  
- `detect_result_screen()` 函数：检测对战结果页面
  - 基于HSV颜色空间的蓝色区域检测
  - 可配置的检测区域和阈值
  
- `click_play_button()` 函数：点击播放按钮
  - 使用相对坐标系统
  - 支持5个播放按钮的精确定位
  
- `record_single_match()` 函数：录制单场对局
  - 自动点击播放按钮
  - 启动录制
  - 循环检测结果页面
  - 自动停止并保存视频
  
- `run()` 函数：模式10主入口
  - 创建输出目录
  - 逐场录制对局
  - 汇总结果

#### MODE10_README.md
用户使用说明文档，包含：
- 功能概述
- 技术实现说明
- 使用方法
- 配置参数说明
- 故障排除指南

### 2. 修改的文件

#### config.json
添加了模式10的配置：
```json
"mode10": {
  "output_filename_suffix": "_recording",
  "num_matches": 5,
  "start_match": 0,
  "video_fps": 60,
  "video_resolution_width": 1920,
  "video_resolution_height": 1080
}
```

添加了模式10的元数据：
```json
{
  "id": 10,
  "name": "自动录屏",
  "desc": "自动点击播放按钮，录制对局回放视频，检测结果页面后停止录屏。",
  "enabled": true,
  "asset_image": "10.png"
}
```

#### app.py
在 `ModeSpecificConfig` 类中添加：
- `_load_mode10_config()` 方法：加载模式10的配置参数
- 在 `mode_loaders` 字典中注册模式10

#### assets/10.png
模式10的图标（当前使用占位符，可后续替换）

## 技术架构

### 录制流程

```
开始
  ↓
激活游戏窗口
  ↓
点击播放按钮
  ↓
等待2秒（视频加载）
  ↓
开始录制（独立线程）
  ↓
主线程循环检测结果页面
  ├─ 每秒检测一次
  ├─ 检测到结果 → 停止录制
  ├─ 超时（5分钟）→ 强制停止
  └─ 停止信号 → 停止录制
  ↓
保存视频文件
  ↓
返回对局列表
  ↓
下一场对局
```

### 核心技术

1. **窗口捕获**
   - 使用 `win32gui.GetClientRect()` 获取窗口客户区
   - 使用 `pyautogui.screenshot()` 截取指定区域
   - 只录制游戏窗口，不录制整个屏幕

2. **视频编码**
   - 使用 OpenCV 的 `VideoWriter`
   - 编码格式：MP4V
   - 可配置帧率和分辨率

3. **图像识别**
   - 转换为HSV色彩空间
   - 检测蓝色区域（结果页面特征色）
   - 计算蓝色像素占比
   - 阈值判断是否为结果页面

4. **坐标系统**
   - 使用相对坐标（0.0-1.0）
   - 自适应不同分辨率
   - 复用现有的 `core.utils.click_coordinates()` 函数

## 配置参数说明

### 播放按钮坐标
```python
play_button_coords_rel = [
    (0.85, 0.35),  # Round 01
    (0.85, 0.45),  # Round 02
    (0.85, 0.55),  # Round 03
    (0.85, 0.65),  # Round 04
    (0.85, 0.75),  # Round 05
]
```

这些坐标是根据您提供的截图估算的，可能需要根据实际游戏界面调整。

### 结果检测参数
```python
# 检测区域（相对坐标）
result_detection_region_rel = (0.1, 0.15, 0.8, 0.4)

# HSV颜色范围（蓝色）
lower_blue = np.array([100, 50, 50])
upper_blue = np.array([130, 255, 255])

# 蓝色占比阈值
blue_ratio_threshold = 0.3
```

### 视频参数
- 默认分辨率：1920x1080
- 默认帧率：60fps
- 编码格式：MP4V
- 最长录制时间：300秒（5分钟）

## 依赖项

模式10需要以下Python库（原项目已包含）：
- `cv2` (OpenCV)
- `numpy`
- `pyautogui`
- `win32gui`
- `PIL`
- `threading`

## 使用示例

### 基本使用
```python
# 在GUI中选择模式10并运行
# 或通过命令行：
python gui_app.py
# 选择模式10 → 点击运行
```

### 自定义配置
修改 `config.json` 中的参数：
```json
"mode10": {
  "num_matches": 3,      // 只录制3场
  "start_match": 2,      // 从第3场开始
  "video_fps": 30        // 降低帧率节省空间
}
```

## 已知限制

1. **Windows专用**：使用了 `win32gui` 等Windows API
2. **性能要求**：60fps录制需要较好的CPU性能
3. **存储空间**：每场对局约100-300MB
4. **检测准确性**：结果页面检测依赖颜色特征，可能需要调整参数

## 未来改进方向

1. **更智能的检测**
   - 使用OCR识别"WIN"/"LOSE"文字
   - 使用模板匹配识别特定UI元素
   - 机器学习模型识别结果页面

2. **视频优化**
   - 支持H.264编码（更高压缩率）
   - 可配置的视频质量参数
   - 自动压缩功能

3. **用户体验**
   - 实时预览录制状态
   - 进度条显示
   - 录制完成后自动打开文件夹

4. **功能扩展**
   - 支持录制特定场次
   - 批量录制多个对局列表
   - 自动上传到云端

## 测试建议

### 功能测试
1. 测试单场录制
2. 测试多场连续录制
3. 测试停止信号响应
4. 测试超时机制

### 兼容性测试
1. 不同游戏分辨率
2. 不同窗口大小
3. 不同系统DPI设置

### 性能测试
1. CPU使用率
2. 内存占用
3. 磁盘写入速度
4. 视频文件大小

## 部署说明

### 打包为可执行文件
使用 PyInstaller（项目已配置）：
```bash
pyinstaller NIKKE_CArena_Helper.spec
```

### 分发
1. 将生成的 `dist/NIKKE_CArena_Helper/` 目录打包
2. 确保包含 `config.json` 和 `assets/` 目录
3. 提供 `MODE10_README.md` 作为用户文档

## 维护说明

### 更新按钮坐标
如果游戏UI更新导致按钮位置变化：
1. 打开 `modes/mode10.py`
2. 修改 `play_button_coords_rel` 列表
3. 重新测试

### 更新检测参数
如果结果页面UI变化：
1. 截取新的结果页面
2. 使用颜色拾取工具确定新的颜色范围
3. 修改 `detect_result_screen()` 中的参数
4. 重新测试

## 联系方式

如有问题或建议，请通过以下方式联系：
- GitHub Issues
- 项目讨论区
- 开发者邮箱

---

**版本**: 1.0  
**日期**: 2026-02-15  
**作者**: Manus AI
